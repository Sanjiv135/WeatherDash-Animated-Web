<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3D District Weather ‚Äì Tamil Nadu & World Cities</title>
<script type="module" crossorigin src="https://unpkg.com/three@0.160.0/build/three.module.js"></script>
<script type="module" crossorigin src="https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js"></script>
<style>
  :root { --bg:#0b1020; --card:rgba(255,255,255,0.08); --text:#eef2ff; --muted:#a3b3ff; }
  html,body{margin:0;height:100%;background:radial-gradient(1200px 600px at 70% 10%, #13214a, #0a0e1f 60%, #060913);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;color:var(--text);overflow:hidden}
  #app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr}
  header{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:14px 18px;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.1));backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,0.06)}
  .brand{font-weight:700;letter-spacing:.3px}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  select,button,input[type="text"]{background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:10px 12px;font-size:14px;outline:none}
  button{cursor:pointer;transition:transform .08s ease, background .2s ease}
  button:hover{transform:translateY(-1px)}
  .accent{background:linear-gradient(180deg,rgba(122,162,255,.35),rgba(122,162,255,.15));border-color:rgba(122,162,255,.45)}
  #canvas-wrap{position:relative}
  #three{position:absolute;inset:0;display:block}
  .hud{position:absolute;right:16px;top:16px;width:320px;max-width:80vw;background:linear-gradient(180deg,rgba(255,255,255,0.09),rgba(255,255,255,0.05));border:1px solid rgba(255,255,255,0.12);border-radius:18px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,0.3);backdrop-filter:blur(8px)}
  .hud h2{margin:0 0 6px 0;font-size:18px}
  .hud .big{font-size:38px;line-height:1.1;font-weight:700}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--card);border:1px solid rgba(255,255,255,0.1);font-size:12px;color:var(--muted)}
  .legend{position:absolute;left:16px;bottom:16px;display:flex;gap:8px;flex-wrap:wrap}
  .legend .pill{background:rgba(255,255,255,0.06)}
  footer{position:absolute;left:50%;transform:translateX(-50%);bottom:8px;font-size:12px;color:#9fb1ff99}
  .badge{font-size:11px;padding:4px 8px;border-radius:10px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.08)}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="brand">üå§Ô∏è 3D Weather ‚Äì Tamil Nadu Districts & Worldwide Cities</div>
    <div class="controls">
      <select id="districtSelect" title="Tamil Nadu districts"></select>
      <button id="geoBtn" class="accent">üìç Use my location</button>
      <input id="searchBox" type="text" placeholder="Search any city worldwide (e.g., Paris, FR)" />
      <button id="searchBtn">Search</button>
    </div>
    <div class="badge" id="status">Idle</div>
  </header>

  <div id="canvas-wrap">
    <canvas id="three"></canvas>

    <div class="hud" id="hud">
      <h2 id="place">‚Äì</h2>
      <div class="big" id="temp">‚Äì¬∞C</div>
      <div id="summary" style="margin-top:6px;color:var(--muted)">‚Äì</div>
      <div class="row">
        <div class="pill" id="pill-wind">Wind: ‚Äì m/s</div>
        <div class="pill" id="pill-hum">Humidity: ‚Äì%</div>
      </div>
      <div class="row">
        <div class="pill" id="pill-clouds">Clouds: ‚Äì%</div>
        <div class="pill" id="pill-press">Pressure: ‚Äì hPa</div>
      </div>
      <div style="margin-top:10px;"><span class="pill" id="sceneTag">Scene: ‚Äì</span></div>
    </div>

    <div class="legend">
      <span class="pill">‚òÄÔ∏è Sun brightness tracks ‚Äúvery/sunny/low‚Äù</span>
      <span class="pill">üí® Wind streaks scale with wind speed</span>
      <span class="pill">üåßÔ∏è Rain particles for rainy/thunder</span>
      <span class="pill">üå´Ô∏è Volumetric fog for fog/mist</span>
      <span class="pill">üòä Pleasant = soft sun + breeze</span>
    </div>

    <footer>Data: OpenWeatherMap ‚Ä¢ 3D: Three.js</footer>
  </div>
</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

/* ===== CONFIG ===== */
const API_KEY = 'YOUR_OPENWEATHER_API_KEY'; // <-- put your key here
const UNITS = 'metric';

/* All 38 Tamil Nadu districts (approx HQ coords) */
const DISTRICTS = [
  { name: "Ariyalur", lat: 11.140, lon: 79.075 },
  { name: "Chengalpattu", lat: 12.691, lon: 79.976 },
  { name: "Chennai", lat: 13.0827, lon: 80.2707 },
  { name: "Coimbatore", lat: 11.0168, lon: 76.9558 },
  { name: "Cuddalore", lat: 11.7447, lon: 79.7680 },
  { name: "Dharmapuri", lat: 12.1211, lon: 78.1587 },
  { name: "Dindigul", lat: 10.3673, lon: 77.9803 },
  { name: "Erode", lat: 11.3410, lon: 77.7172 },
  { name: "Kallakurichi", lat: 11.738, lon: 78.963 },
  { name: "Kanchipuram", lat: 12.8350, lon: 79.7040 },
  { name: "Kanyakumari", lat: 8.0883, lon: 77.5385 },
  { name: "Karur", lat: 10.9601, lon: 78.0766 },
  { name: "Krishnagiri", lat: 12.5186, lon: 78.2137 },
  { name: "Madurai", lat: 9.9252, lon: 78.1198 },
  { name: "Mayiladuthurai", lat: 11.103, lon: 79.652 },
  { name: "Nagapattinam", lat: 10.767, lon: 79.843 },
  { name: "Namakkal", lat: 11.219, lon: 78.167 },
  { name: "Nilgiris (Ooty)", lat: 11.4064, lon: 76.6932 },
  { name: "Perambalur", lat: 11.234, lon: 78.880 },
  { name: "Pudukkottai", lat: 10.379, lon: 78.821 },
  { name: "Ramanathapuram", lat: 9.3645, lon: 78.8397 },
  { name: "Ranipet", lat: 12.944, lon: 79.318 },
  { name: "Salem", lat: 11.6643, lon: 78.1460 },
  { name: "Sivaganga", lat: 9.847, lon: 78.484 },
  { name: "Tenkasi", lat: 8.959, lon: 77.315 },
  { name: "Thanjavur", lat: 10.7870, lon: 79.1378 },
  { name: "Theni", lat: 10.010, lon: 77.476 },
  { name: "Thoothukudi (Tuticorin)", lat: 8.7642, lon: 78.1348 },
  { name: "Tiruchirappalli", lat: 10.7905, lon: 78.7047 },
  { name: "Tirunelveli", lat: 8.7139, lon: 77.7567 },
  { name: "Tirupathur", lat: 12.497, lon: 78.571 },
  { name: "Tiruppur", lat: 11.1085, lon: 77.3411 },
  { name: "Tiruvallur", lat: 13.144, lon: 79.908 },
  { name: "Tiruvannamalai", lat: 12.2253, lon: 79.0747 },
  { name: "Tiruvarur", lat: 10.772, lon: 79.636 },
  { name: "Vellore", lat: 12.9165, lon: 79.1325 },
  { name: "Viluppuram", lat: 11.939, lon: 79.487 },
  { name: "Virudhunagar", lat: 9.587, lon: 77.957 }
];

/* ===== DOM ===== */
const canvas = document.getElementById('three');
const selectEl = document.getElementById('districtSelect');
const geoBtn = document.getElementById('geoBtn');
const statusEl = document.getElementById('status');
const placeEl = document.getElementById('place');
const tempEl = document.getElementById('temp');
const summaryEl = document.getElementById('summary');
const pillWind = document.getElementById('pill-wind');
const pillHum = document.getElementById('pill-hum');
const pillClouds = document.getElementById('pill-clouds');
const pillPress = document.getElementById('pill-press');
const sceneTag = document.getElementById('sceneTag');
const searchBox = document.getElementById('searchBox');
const searchBtn = document.getElementById('searchBtn');

/* Populate district list */
DISTRICTS.forEach((d, i) => {
  const opt = document.createElement('option');
  opt.value = i; opt.textContent = d.name;
  selectEl.appendChild(opt);
});

/* ===== 3D Scene ===== */
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(innerWidth, innerHeight);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x060913);
scene.fog = new THREE.Fog(0x0a0f20, 40, 160);

const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,8,22);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.autoRotate = true; controls.autoRotateSpeed = 0.3;
controls.enablePan = false; controls.minDistance = 10; controls.maxDistance = 60;
controls.minPolarAngle = Math.PI*0.10; controls.maxPolarAngle = Math.PI*0.90;

/* Ground */
const ground = new THREE.Mesh(
  new THREE.CircleGeometry(40,128),
  new THREE.MeshStandardMaterial({ color:0x0f1735, metalness:0.1, roughness:0.9 })
);
ground.rotation.x = -Math.PI/2; ground.receiveShadow = true; scene.add(ground);

/* Sky dome */
const sky = new THREE.Mesh(
  new THREE.SphereGeometry(200,64,32),
  new THREE.ShaderMaterial({
    side: THREE.BackSide,
    uniforms:{ topColor:{value:new THREE.Color(0x0b1b52)}, bottomColor:{value:new THREE.Color(0x060913)} },
    vertexShader:`varying vec3 vPos; void main(){ vPos=position; gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);} `,
    fragmentShader:`uniform vec3 topColor; uniform vec3 bottomColor; varying vec3 vPos;
      void main(){ float h = normalize(vPos).y*0.5+0.5; gl_FragColor = vec4(mix(bottomColor, topColor, h),1.0);} `
  })
);
scene.add(sky);

/* Lights / Sun */
const hemi = new THREE.HemisphereLight(0x6da8ff, 0x0b122a, 0.4); scene.add(hemi);
const sunLight = new THREE.DirectionalLight(0xffe9a6, 1.0); sunLight.position.set(12,25,8); scene.add(sunLight);
const sun = new THREE.Mesh(new THREE.SphereGeometry(2.2,48,48), new THREE.MeshBasicMaterial({ color:0xfff2b2 }));
sun.position.copy(sunLight.position); scene.add(sun);

/* Clouds */
const cloudGroup = new THREE.Group(); scene.add(cloudGroup);
(function createCloudRing(radius=18,count=8){
  for(let i=0;i<count;i++){
    const puff = new THREE.Mesh(
      new THREE.SphereGeometry(THREE.MathUtils.randFloat(1.4,2.4),24,24),
      new THREE.MeshStandardMaterial({ color:0xffffff, roughness:1, metalness:0, transparent:true, opacity:0.22 })
    );
    const a = (i/count)*Math.PI*2 + Math.random()*0.4;
    puff.position.set(Math.cos(a)*radius, THREE.MathUtils.randFloat(5,10), Math.sin(a)*radius);
    puff.rotation.y = Math.random()*Math.PI; puff.userData.drift = THREE.MathUtils.randFloat(0.1,0.6);
    cloudGroup.add(puff);
  }
})();

/* Particles (rain/snow/fog) */
const MAX_PARTICLES = 2000;
const particleGeo = new THREE.BufferGeometry();
const positions = new Float32Array(MAX_PARTICLES*3);
const velocities = new Float32Array(MAX_PARTICLES);
for(let i=0;i<MAX_PARTICLES;i++){
  positions[i*3] = THREE.MathUtils.randFloatSpread(60);
  positions[i*3+1] = THREE.MathUtils.randFloat(5,60);
  positions[i*3+2] = THREE.MathUtils.randFloatSpread(60);
  velocities[i] = THREE.MathUtils.randFloat(0.02,0.35);
}
particleGeo.setAttribute('position', new THREE.BufferAttribute(positions,3));
particleGeo.setAttribute('velocity', new THREE.BufferAttribute(velocities,1));
const particleMat = new THREE.PointsMaterial({ size:0.08, transparent:true, opacity:0.0, depthWrite:false });
const particles = new THREE.Points(particleGeo, particleMat); scene.add(particles);

/* Wind streaks */
const windCount = 120;
const windGeo = new THREE.BufferGeometry();
const windPos = new Float32Array(windCount*3);
const windVel = new Float32Array(windCount);
for(let i=0;i<windCount;i++){
  windPos[i*3] = THREE.MathUtils.randFloat(-30,30);
  windPos[i*3+1] = THREE.MathUtils.randFloat(2,15);
  windPos[i*3+2] = THREE.MathUtils.randFloat(-30,30);
  windVel[i] = THREE.MathUtils.randFloat(0.1,0.7);
}
windGeo.setAttribute('position', new THREE.BufferAttribute(windPos,3));
const windMat = new THREE.PointsMaterial({ size:0.22, transparent:true, opacity:0.0, depthWrite:false });
const wind = new THREE.Points(windGeo, windMat); scene.add(wind);

/* Animate */
let clock = new THREE.Clock(); let windStrength = 0.0;
function animate(){
  requestAnimationFrame(animate);
  const t = clock.getElapsedTime();
  cloudGroup.children.forEach((p,i)=>{ p.position.x += Math.sin(t*p.userData.drift+i)*0.002; p.position.z += Math.cos(t*(p.userData.drift*0.8)+i)*0.002; });
  sun.position.y = 25 + Math.sin(t*0.6)*0.6; sunLight.position.copy(sun.position);
  const pos = particles.geometry.attributes.position.array;
  const vel = particles.geometry.attributes.velocity.array;
  for(let i=0;i<MAX_PARTICLES;i++){
    pos[i*3+1] -= vel[i];
    pos[i*3] += windStrength*0.05;
    if(pos[i*3+1] < 0){ pos[i*3] = THREE.MathUtils.randFloatSpread(60); pos[i*3+1] = THREE.MathUtils.randFloat(10,60); pos[i*3+2] = THREE.MathUtils.randFloatSpread(60); }
  }
  particles.geometry.attributes.position.needsUpdate = true;
  const wpos = wind.geometry.attributes.position.array;
  for(let i=0;i<windCount;i++){
    wpos[i*3] += windVel[i] + windStrength*0.2;
    wpos[i*3+1] += Math.sin(t*0.5+i)*0.02;
    if(wpos[i*3] > 35){ wpos[i*3] = -35; wpos[i*3+1] = THREE.MathUtils.randFloat(2,15); wpos[i*3+2] = THREE.MathUtils.randFloat(-30,30); }
  }
  wind.geometry.attributes.position.needsUpdate = true;
  controls.update(); renderer.render(scene,camera);
}
animate();

/* Resize */
addEventListener('resize', ()=>{ camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); });

/* ===== Weather logic ===== */
function setStatus(s){ statusEl.textContent = s; }

function mapWeatherToScene(data){
  const main = (data.weather?.[0]?.main || '').toLowerCase();
  const description = (data.weather?.[0]?.description || '').toLowerCase();
  const temp = data.main?.temp ?? 0;
  const windSpeed = data.wind?.speed ?? 0;
  const clouds = data.clouds?.all ?? 0;
  const humidity = data.main?.humidity ?? 0;

  const isThunder = main.includes('thunder');
  const isSnow = main.includes('snow');
  const isRain = main.includes('rain') || main.includes('drizzle');
  const isFog = ['mist','fog','haze','smoke','dust','sand'].some(k => main.includes(k) || description.includes(k));
  const isWindy = windSpeed >= 10;

  let sceneName = 'Pleasant';
  if (isThunder) sceneName = 'Thunderstorm';
  else if (isSnow) sceneName = 'Snowy';
  else if (isRain) sceneName = 'Rainy';
  else if (isFog) sceneName = 'Foggy';
  else {
    if (clouds <= 10 && temp >= 33) sceneName = 'Very Sunny';
    else if (clouds <= 35) sceneName = 'Sunny';
    else if (clouds <= 70) sceneName = 'Low Sunny';
    else sceneName = 'Overcast';
  }
  const windyOverlay = isWindy && !isRain && !isFog;
  return { sceneName, temp, windSpeed, clouds, humidity, pressure: data.main?.pressure ?? 0, windyOverlay, description: data.weather?.[0]?.description ?? '' };
}

let currentState = null;
function applySceneVisuals(state){
  const { sceneName, windyOverlay } = state;
  let sunI=0.8, amb=0.35, pOpacity=0.0, pSize=0.08, wOpacity=0.0, fogNear=40, fogFar=160;

  switch(sceneName){
    case 'Very Sunny': sunI=2.1; amb=0.55; windStrength=0.03; break;
    case 'Sunny':      sunI=1.4; amb=0.45; windStrength=0.02; break;
    case 'Low Sunny':  sunI=0.9; amb=0.40; windStrength=0.02; break;
    case 'Overcast':   sunI=0.35; amb=0.35; windStrength=0.01; break;
    case 'Rainy':      sunI=0.25; amb=0.35; pOpacity=0.85; pSize=0.06; windStrength=0.02; fogNear=35; fogFar=120; break;
    case 'Snowy':      sunI=0.35; amb=0.45; pOpacity=0.9;  pSize=0.12; windStrength=0.015; break;
    case 'Foggy':      sunI=0.3;  amb=0.40; pOpacity=0.35; pSize=0.14; windStrength=0.005; fogNear=15; fogFar=80; break;
    case 'Thunderstorm': sunI=0.2; amb=0.30; pOpacity=0.95; pSize=0.06; windStrength=0.05; fogNear=25; fogFar=100; break;
    default:           sunI=1.0; amb=0.50; windStrength=0.02; break;
  }
  wOpacity = windyOverlay ? 0.8 : ((sceneName==='Very Sunny'||sceneName==='Sunny'||sceneName==='Pleasant') ? 0.25 : 0.05);

  sunLight.intensity = sunI; hemi.intensity = amb;
  particles.material.opacity = pOpacity; particles.material.size = pSize; particles.material.needsUpdate = true;
  wind.material.opacity = wOpacity; wind.material.needsUpdate = true;
  scene.fog.near = fogNear; scene.fog.far = fogFar;

  const cloudsPct = currentState?.clouds ?? 40;
  cloudGroup.children.forEach(p => { p.material.opacity = THREE.MathUtils.mapLinear(cloudsPct, 0, 100, 0.05, 0.32); p.material.needsUpdate = true; });
  sceneTag.textContent = `Scene: ${sceneName}${windyOverlay ? ' + Windy' : ''}`;
}

function updateHUD(placeName, data, m){
  placeEl.textContent = placeName;
  tempEl.textContent = `${Math.round(m.temp)}¬∞C`;
  const desc = m.description ? m.description[0].toUpperCase() + m.description.slice(1) : (data.weather?.[0]?.main || '‚Äî');
  summaryEl.textContent = desc;
  pillWind.textContent = `Wind: ${Math.round(m.windSpeed*10)/10} m/s`;
  pillHum.textContent = `Humidity: ${m.humidity}%`;
  pillClouds.textContent = `Clouds: ${m.clouds}%`;
  pillPress.textContent = `Pressure: ${m.pressure} hPa`;
}

/* Fetch helpers */
async function fetchWeatherByLatLon(lat, lon){
  const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=${UNITS}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Weather fetch failed');
  return res.json();
}
async function geocodeCity(q){
  const url = `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(q)}&limit=1&appid=${API_KEY}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Geocoding failed');
  const data = await res.json();
  if(!data?.length) throw new Error('Place not found');
  const d = data[0];
  return { lat:d.lat, lon:d.lon, name: `${d.name}${d.state?`, ${d.state}`:''}${d.country?`, ${d.country}`:''}` };
}

/* Loaders */
async function loadByLatLon(lat, lon, displayName='Selected Location'){
  try{
    setStatus('Loading‚Ä¶');
    const data = await fetchWeatherByLatLon(lat, lon);
    const mapped = mapWeatherToScene(data);
    currentState = mapped;
    updateHUD(displayName || data.name || 'Selected Location', data, mapped);
    applySceneVisuals(mapped);
    setStatus('Loaded');
  }catch(e){ console.error(e); setStatus('Error'); alert('Could not fetch weather. Check API key or network.'); }
}

/* Events */
selectEl.addEventListener('change', ()=>{
  const d = DISTRICTS[selectEl.value];
  if(d) loadByLatLon(d.lat, d.lon, d.name);
});
geoBtn.addEventListener('click', ()=>{
  if(!navigator.geolocation) return alert('Geolocation not supported.');
  setStatus('Locating‚Ä¶');
  navigator.geolocation.getCurrentPosition(
    pos => loadByLatLon(pos.coords.latitude, pos.coords.longitude, 'Your Location'),
    err => { console.warn(err); setStatus('Idle'); alert('Could not get your location.'); },
    { enableHighAccuracy:true, timeout:10000 }
  );
});
searchBtn.addEventListener('click', async ()=>{
  const q = searchBox.value.trim(); if(!q) return;
  try{ setStatus('Searching‚Ä¶'); const g = await geocodeCity(q); await loadByLatLon(g.lat, g.lon, g.name); }
  catch(e){ console.error(e); setStatus('Idle'); alert('Place not found. Try ‚ÄúCity, CountryCode‚Äù e.g., ‚ÄúParis, FR‚Äù.'); }
});
searchBox.addEventListener('keydown', (e)=>{ if(e.key==='Enter') searchBtn.click(); });

/* Initial load: Chennai */
loadByLatLon(DISTRICTS.find(d=>d.name==='Chennai').lat, DISTRICTS.find(d=>d.name==='Chennai').lon, 'Chennai');
</script>
</body>
</html>
